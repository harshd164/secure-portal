<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Beneficiary Inbox</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-dark: #020617;
        --card-bg: #1e293b;
        --text-main: #ffffff;
        --text-muted: #94a3b8;
        --primary: #3b82f6;
      }
      body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: "Segoe UI", sans-serif;
        min-height: 100vh;
      }
      .navbar {
        background: #0f172a;
        border-bottom: 1px solid #1e293b;
        padding: 1rem 1.5rem;
      }
      .doc-card {
        background: var(--card-bg);
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .file-icon {
        width: 50px;
        height: 50px;
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1.5rem;
      }
      .file-info h5 {
        color: white;
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: 1.1rem;
      }
      .file-info p {
        color: var(--text-muted);
        margin: 0;
        font-size: 0.9rem;
      }
      .expiry-badge {
        background: #0f172a;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 1px solid #334155;
        color: #cbd5e1;
        font-family: "Courier New", monospace;
        font-size: 0.95rem;
        margin-right: 1.5rem;
        min-width: 220px;
        text-align: center;
      }
      .btn-view {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
      }
      .modal-content {
        background: #1e293b;
        color: white;
        border: 1px solid #475569;
      }
      .form-control {
        background: #0f172a;
        border: 1px solid #475569;
        color: white;
        font-size: 1.2rem;
        letter-spacing: 2px;
        text-align: center;
      }
      .form-control:focus {
        background: #020617;
        border-color: var(--primary);
        color: white;
      }
      .location-tag {
        font-size: 0.85rem;
        color: #10b981;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-dark d-flex justify-content-between align-items-center"
    >
      <div class="d-flex align-items-center">
        <i class="fas fa-shield-alt text-primary fa-lg me-3"></i>
        <span class="h5 mb-0 fw-bold text-white">SecureInbox</span>
      </div>
      <div class="d-flex align-items-center gap-4 text-secondary small">
        <span class="location-tag" id="gps-coords">
          <i class="fas fa-satellite-dish me-2 fa-spin"></i>Triangulating GPS...
        </span>
        <span class="border-start border-secondary border-opacity-25 ps-3">
          <i class="fas fa-network-wired me-2"></i>ISP City: {{ city }}
        </span>
        <a href="/logout" class="text-danger"
          ><i class="fas fa-sign-out-alt"></i
        ></a>
      </div>
    </nav>

    <div class="container mt-5">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} bg-dark border-{{ category }} text-{{ category }} mb-4"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <h6 class="text-uppercase text-secondary fw-bold mb-4 tracking-wide">
        Available Secure Documents
      </h6>

      {% for file in files %}
      <div class="doc-card">
        <div class="d-flex align-items-center">
          <div class="file-icon"><i class="fas fa-file-invoice"></i></div>
          <div class="file-info">
            <h5>{{ file[1] }}</h5>
            <p>Sender: <span class="text-light">{{ file[2] }}</span></p>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <div class="expiry-badge">
            <i class="far fa-clock me-2 text-warning"></i>
            <span class="expiry-timer" data-expiry="{{ file[3] }}"
              >Calculating...</span
            >
          </div>
          <button
            class="btn-view"
            data-bs-toggle="modal"
            data-bs-target="#authModal{{ file[0] }}"
          >
            OPEN
          </button>
        </div>
      </div>

      <div class="modal fade" id="authModal{{ file[0] }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Identity Verification</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body p-4 text-center">
              <p class="text-secondary mb-4">
                Enter PIN for <br /><strong class="text-white"
                  >{{ file[1] }}</strong
                >
              </p>
              <form action="/view/{{ file[0] }}" method="POST" target="_blank">
                <input
                  type="password"
                  name="pin"
                  class="form-control mb-4"
                  placeholder="ENTER PIN"
                  required
                />

                <!-- HIDDEN FIELDS FOR PRECISE LOCATION -->
                <input
                  type="hidden"
                  name="client_lat"
                  id="lat_field_{{ file[0] }}"
                />
                <input
                  type="hidden"
                  name="client_lon"
                  id="lon_field_{{ file[0] }}"
                />

                <button
                  type="submit"
                  class="btn btn-primary w-100 py-3 fw-bold"
                >
                  DECRYPT & VIEW
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 1. HIGH ACCURACY GEOLOCATION
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            const acc = pos.coords.accuracy.toFixed(0);

            document.getElementById(
              "gps-coords"
            ).innerHTML = `<i class="fas fa-crosshairs me-2"></i>${lat}, ${lng} (Â±${acc}m)`;
            document
              .getElementById("gps-coords")
              .classList.remove("text-danger");

            // Fill Hidden Inputs
            document
              .querySelectorAll('[id^="lat_field_"]')
              .forEach((el) => (el.value = lat));
            document
              .querySelectorAll('[id^="lon_field_"]')
              .forEach((el) => (el.value = lng));
          },
          (err) => {
            document.getElementById(
              "gps-coords"
            ).innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>GPS Denied`;
            document.getElementById("gps-coords").classList.add("text-danger");
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      // 2. PRECISE TIMER (DD:HH:MM:SS)
      document.querySelectorAll(".expiry-timer").forEach((el) => {
        const expiryDate = new Date(el.dataset.expiry);
        const updateTimer = () => {
          const now = new Date();
          const diffMs = expiryDate - now;

          if (diffMs < 0) {
            el.innerText = "EXPIRED";
            el.parentElement.classList.add("text-danger", "border-danger");
            el.parentElement.classList.remove("text-warning");
            // Disable button
            const btn = el.closest(".doc-card").querySelector("button");
            if (btn) btn.style.display = "none";
          } else {
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
              (diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const minutes = Math.floor(
              (diffMs % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);

            const d = days > 0 ? `${days}d ` : "";
            const h = hours.toString().padStart(2, "0");
            const m = minutes.toString().padStart(2, "0");
            const s = seconds.toString().padStart(2, "0");
            el.innerText = `${d}${h}h:${m}m:${s}s`;
          }
        };
        updateTimer();
        setInterval(updateTimer, 1000);
      });
    </script>
  </body>
</html>
